# Source of Truth (SoT) — единые правила "где правда"

> Цель: убрать противоречия между документами и кодом.  
> Правило: **если два источника конфликтуют — действует источник с более высоким приоритетом из списка ниже.**

---

## 1) Приоритет источников (сверху важнее)

### P0 — Контракты модулей (самое конкретное)
- **Что описывает:** поведение конкретного модуля, входы/выходы, edge cases, DoD.
- **Источник:** `modules/<module>/contract.md`
- **Проверка:** `modules/<module>/tests.md`

**Если конфликт:** контракт модуля > всё, что ниже (кроме P-1).

---

### P1 — Глобальные требования проекта (правила для всех модулей)
- **Что описывает:** UX/форматы, ограничения, роли, non-goals, общие принципы.
- **Источник:** `docs/requirements.md` (или `docs/requirements_short.md`, если он “главный”)

**Если конфликт:** requirements > README/runbook/glossary.

---

### P2 — Эксплуатация и качество (как поддерживаем и проверяем)
- **Источники:**
  - `docs/runbook.md` — деплой, инциденты, команды, восстановление
  - `docs/health.md` — health checklist/операционные проверки
  - `docs/tests.md` — общие правила тестов (если есть)
- **Важно:** эти документы не меняют “что система делает”, они фиксируют “как мы её запускаем/проверяем”.

---

### P3 — Безопасность и секреты
- **Источники:**
  - `docs/security.md`
  - `.gitignore`
- **Правило:** безопасность всегда имеет приоритет над удобством.  
  Если документ предлагает небезопасное действие — оно запрещено даже если “так быстрее”.

---

### P4 — Словарь терминов (значения слов)
- **Источник:** `docs/glossary.md`
- **Правило:** если термин используется в 2+ модулях — он обязан быть в glossary.

---

### P5 — Обзор и навигация (для ориентира)
- **Источник:** `README.md`
- **Правило:** README — “карта и быстрый старт”, не место для тонких контрактов.

---

## 2) Правило анти-дублирования (очень важно)

### 2.1 Не дублируем правила без ссылки
Если правило уже существует в источнике более высокого приоритета:
- **не копируй его текст** в другой файл;
- вместо этого добавь **ссылку** на первоисточник и 1 строку “зачем тут упомянуто”.

Пример:
- ✅ “См. `docs/requirements.md#Formats` — используем JSON schema v2”
- ❌ “Повторяем полностью формат и примеры в README”

---

## 3) Что делать при конфликте (процедура)

1) Найти **первичный источник** по приоритету (P0 → P5).  
2) Исправить **только первичный источник**.  
3) В остальных местах:
   - заменить дубли на ссылку, или
   - добавить пометку `NOTE: See <source>`.

Если конфликт “между модулями”:
- правду фиксируем в `docs/requirements.md` или в `docs/glossary.md`,
- а в модульных контрактах даём ссылку на это решение.

---

## 4) Метки статуса (чтобы не гадать)

- `CANONICAL` — это первичный источник (истина здесь).
- `DERIVED` — это производное описание (ссылка на CANONICAL).
- `DEPRECATED` — устарело, не использовать, указать замену.

Рекомендация:
- CANONICAL: requirements/contract/security/glossary
- DERIVED: README/runbook (часто)

---

## 5) Мини-чеклист перед изменением документа

Перед правкой ответь “да/нет”:
- Я правлю **самый высокий приоритетный** источник?
- Я **не создаю дубликат** (или ставлю ссылку)?
- Я понимаю, какие модули это затронет?
- Я обновил тесты/DoD там, где нужно?

---

## 6) Примечание для агента/Codex (если используете)
- Если находишь конфликт — **не пытайся “синхронизировать всё”**.  
  Исправь CANONICAL и замени дубли на ссылки.
- Если нет уверенности, где CANONICAL — спроси 1 вопрос и остановись.
