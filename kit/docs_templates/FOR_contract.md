# Module Contract — <MODULE_NAME>
Версия: v0.1  
Дата: <YYYY-MM-DD>  
Владелец: <you>  
Режим: MODULES-FIRST (мини-бот внутри бота)

## 0) Назначение модуля (2–4 строки)
- Что делает модуль: …
- Для кого (роль/сегмент): …
- Какие 1–2 вещи **не** делает (non-goals): …

## 1) Входы (как пользователь попадает в модуль)
### 1.1 Триггеры
- Кнопка меню: `<button_text>` → `<module entry action>`
- Команды (если есть): `/...`
- Callback prefix’ы (обязательно):  
  - `<PREFIX_1>` — …
  - `<PREFIX_2>` — …

### 1.2 Preconditions (если есть)
- Роль/доступ: …
- Нужные настройки пользователя: …
- Что делаем, если условий нет: (сообщение/alert/редирект в меню)

## 2) Карта сценария (Flow / “карта метро”)
Опиши 1 основной сценарий + важные ответвления.

### 2.1 Основной сценарий (Happy Path)
1) Экран A: … (что видит) → кнопки: …
2) Экран B: … → кнопки: …
3) Экран C: … → подтверждение: …
4) Выход: … (куда возвращаем / что остаётся в чате)

### 2.2 Ветки
- Назад: откуда куда, что очищаем
- Отмена: что сбрасываем, куда возвращаем
- Повтор действия (double click): что должно быть
- Ошибка ввода: что показываем, куда остаёмся

## 3) UX-правила внутри модуля (коридор)
(если глобальные правила уже в docs/requirements.md — здесь только специфичное)

- Clean chat: edit / delete input / когда можно send
- Сообщения ошибок: формат (текст + пример ввода)
- Навигация: всегда есть Меню/Назад (где именно)
- Callback: `answer()` всегда и быстро (nohang)

## 4) Состояния (FSM) — если используешь
### 4.1 Список состояний
- `<STATE_1>` — ожидаем …
- `<STATE_2>` — ожидаем …

### 4.2 Переходы
- `<STATE_1>` → `<STATE_2>`: при …
- `<STATE_2>` → `None/END`: при …

### 4.3 Cleanup (что чистим)
- Какие временные ключи/черновики удаляем при:
  - успехе
  - ошибке
  - отмене/назад

## 5) Данные и хранение (что читаем/пишем)
### 5.1 Сущности (локальные для модуля)
- `<Entity>`: кратко + зачем
- `<Entity>`: …

### 5.2 Что читаем
- key/таблица: … → зачем

### 5.3 Что пишем
- key/таблица: … → когда пишем
- атомарность/безопасность (если важно): …

### 5.4 Консистентность
- Что должно быть истинно после операции (инварианты):
  - пример: “если статус = CONFIRMED, то …”
  - пример: “UI не показывает то, чего нет в storage”

## 6) Валидации и ошибки (FormatGate)
### 6.1 Ввод пользователя
- Формат: …
- Диапазон: …
- Нормализация: (trim/замена запятых/таймзона/округление)
- Если невалидно: точный текст ошибки + пример правильного ввода

### 6.2 Ошибки системы
- storage/network: что показываем пользователю
- fallback: что делаем дальше (остаемся в шаге / в меню)

## 7) Пересечения с другими модулями (очень важно)
- Что этот модуль **читает** из общего контекста (например timezone/role/лимиты): …
- Что этот модуль **влияет** на другие (например настройки дедлайна записи): …

**Правило:** если правило/данные используются 2+ модулями → кандидат в `shared/` или в `docs/requirements.md`.

## 8) Definition of Done (модуль)
- [ ] Happy path работает end-to-end
- [ ] Edge cases обработаны (см. ниже)
- [ ] NoHang: callback.answer() везде
- [ ] Clean chat соблюдён
- [ ] Есть tests.md и он пройден

## 9) Edge Cases (3–10 пунктов)
1) …
2) …
3) …
(пусто/невалидно/двойной клик/назад/отмена/параллельные нажатия/нет данных)

## 10) Acceptance (что должно быть видно пользователю)
- Экран(ы) после успеха: …
- Сообщения ошибок (точные формулировки): …
- Что меняется в данных: …

---

## 11) Связанные файлы модуля (для Codex)
Обязательные:
- `router.py` — …
- `keyboards.py` — …
- `screens.py` — …
- `callbacks.py` — …
- `tests.md` — …

По необходимости:
- `states.py`, `services.py`, `repo.py`, `errors.py`, `rules.py`, `assets/`
